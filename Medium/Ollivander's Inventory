SELECT ID, AGE, COINS_NEEDED, PWR
FROM
(
SELECT P.CODE, W.ID, P.AGE, COINS_NEEDED, W.POWER PWR, RANK() OVER(PARTITION BY P.CODE,P.AGE,W.POWER ORDER BY COINS_NEEDED) RNK
FROM WANDS W LEFT JOIN WANDS_PROPERTY P ON W.CODE = P.CODE
WHERE IS_EVIL = 0
) 
WHERE RNK=1
ORDER BY PWR DESC, AGE DESC;
